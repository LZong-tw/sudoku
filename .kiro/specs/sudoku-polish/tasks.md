# 實施計劃：數獨遊戲全面改進

## 概述

本實施計劃將現有的單文件 HTML 數獨遊戲重構為模塊化、功能豐富的應用。實施將分階段進行，從核心架構開始，逐步添加功能，最後進行集成和優化。

## 任務

- [x] 1. 建立項目結構和核心基礎設施
  - 創建模塊化的目錄結構（core/、features/、storage/、ui/、utils/）
  - 實現 EventBus 發布/訂閱系統
  - 實現 ErrorHandler 全局錯誤處理
  - 設置測試框架（Jest/Vitest 和 fast-check）
  - _需求：15.1, 16.3_

- [x] 2. 實現核心數據模型和驗證
  - [x] 2.1 實現 GridModel 類
    - 實現網格數據結構（puzzle、solution、current、notes、fixed）
    - 實現 setValue、getValue、toggleNote、getNotes 方法
    - 實現 isValid、getConflicts 驗證方法
    - 實現 isComplete、isCorrect 檢查方法
    - 實現 clone、toJSON、fromJSON 序列化方法
    - _需求：1.1, 3.1, 3.2, 3.3, 3.4, 4.1, 4.5_

  - [x] 2.2 為 GridModel 編寫基於屬性的測試
    - **屬性 9: 填入答案清除筆記**
    - **驗證需求：3.3**

  - [x] 2.3 為 GridModel 編寫基於屬性的測試
    - **屬性 10: 有答案的格子不允許筆記**
    - **驗證需求：3.4**

  - [x] 2.4 為 GridModel 編寫基於屬性的測試
    - **屬性 11: 自動檢查驗證規則違反**
    - **驗證需求：4.1, 4.5**

  - [x] 2.5 為 GridModel 編寫基於屬性的測試
    - **屬性 12: 衝突檢測的完整性**
    - **驗證需求：4.2**

- [x] 3. 實現歷史管理和撤銷/重做
  - [x] 3.1 實現 HistoryManager 類
    - 實現歷史記錄棧和當前索引管理
    - 實現 push、undo、redo 方法
    - 實現 canUndo、canRedo 檢查方法
    - 支持所有操作類型（SET_VALUE、TOGGLE_NOTE、CLEAR_CELL、HINT_USED）
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

  - [ ]* 3.2 為 HistoryManager 編寫基於屬性的測試
    - **屬性 4: 撤銷/重做 Round-Trip**
    - **驗證需求：2.1, 2.2**

  - [ ]* 3.3 為 HistoryManager 編寫基於屬性的測試
    - **屬性 5: 新操作清除重做歷史**
    - **驗證需求：2.5**

  - [ ]* 3.4 為 HistoryManager 編寫基於屬性的測試
    - **屬性 6: 所有操作類型被記錄**
    - **驗證需求：2.6**

- [x] 4. 實現提示系統
  - [x] 4.1 實現 HintSystem 類
    - 實現 getHint 方法選擇空白格子並返回正確答案
    - 實現 selectBestHintCell 啟發式算法
    - 實現 calculateCellDifficulty 難度評分
    - 實現提示計數追蹤
    - _需求：1.1, 1.2, 1.3, 1.4, 1.5_

  - [ ]* 4.2 為 HintSystem 編寫基於屬性的測試
    - **屬性 1: 提示填入正確答案**
    - **驗證需求：1.1**

  - [ ]* 4.3 為 HintSystem 編寫基於屬性的測試
    - **屬性 2: 提示使用計數遞增**
    - **驗證需求：1.2**

  - [ ]* 4.4 為 HintSystem 編寫基於屬性的測試
    - **屬性 3: 提示格子被正確標記**
    - **驗證需求：1.4**

  - [ ]* 4.5 編寫單元測試
    - 測試網格已滿時提示不可用
    - 測試邊緣情況
    - _需求：1.3_


- [x] 5. 實現存儲管理和數據持久化
  - [x] 5.1 實現 StorageManager 類
    - 實現 localStorage 可用性檢測
    - 實現 save、load、remove、clear 基礎方法
    - 實現 saveGameState、loadGameState 方法
    - 實現 saveSettings、loadSettings 方法
    - 實現 saveStatistics、loadStatistics 方法
    - 實現錯誤處理（localStorage 不可用、配額超限）
    - _需求：6.1, 6.2, 6.3, 6.4, 6.5, 16.1_

  - [x] 5.2 實現 DataValidator 類
    - 實現 validateGameState 方法
    - 實現 validateSettings 方法
    - 實現 validateStatistics 方法
    - 為無效數據提供默認值
    - _需求：16.2, 16.4_

  - [ ]* 5.3 為存儲管理編寫基於屬性的測試
    - **屬性 14: 遊戲狀態持久化 Round-Trip**
    - **驗證需求：6.1, 6.2, 6.4**

  - [ ]* 5.4 為存儲管理編寫基於屬性的測試
    - **屬性 33: 無效數據使用默認值**
    - **驗證需求：16.2**

  - [ ]* 5.5 為存儲管理編寫基於屬性的測試
    - **屬性 34: 數據驗證完整性**
    - **驗證需求：16.4**

  - [ ]* 5.6 編寫單元測試
    - 測試 localStorage 不可用情況
    - 測試遊戲完成時清除進度
    - _需求：6.3, 6.5, 16.1_

- [x] 6. 檢查點 - 核心功能驗證
  - 確保所有核心模塊測試通過
  - 驗證網格操作、歷史管理、提示系統和存儲功能正常工作
  - 如有問題請詢問用戶

- [x] 7. 實現統計追蹤系統
  - [x] 7.1 實現 StatisticsTracker 類
    - 實現按難度分類的統計數據結構
    - 實現 recordGameStart、recordGameComplete 方法
    - 實現 getStats、getAllStats 方法
    - 實現統計計算（平均時間、勝率）
    - 實現 toJSON、fromJSON 序列化方法
    - _需求：7.1, 7.2, 7.3, 7.4, 7.5_

  - [ ]* 7.2 為 StatisticsTracker 編寫基於屬性的測試
    - **屬性 15: 統計數據正確更新**
    - **驗證需求：7.1**

  - [ ]* 7.3 為 StatisticsTracker 編寫基於屬性的測試
    - **屬性 16: 最佳時間記錄更新**
    - **驗證需求：7.2**

  - [ ]* 7.4 為 StatisticsTracker 編寫基於屬性的測試
    - **屬性 17: 統計計算正確性**
    - **驗證需求：7.3**

  - [ ]* 7.5 為 StatisticsTracker 編寫基於屬性的測試
    - **屬性 18: 統計數據持久化 Round-Trip**
    - **驗證需求：7.4**

  - [ ]* 7.6 為 StatisticsTracker 編寫基於屬性的測試
    - **屬性 19: 難度統計隔離**
    - **驗證需求：7.5**

- [x] 8. 實現成就系統
  - [x] 8.1 實現 AchievementSystem 類
    - 定義至少 10 個成就（首次勝利、完美遊戲、速度惡魔等）
    - 實現 initializeAchievements 方法
    - 實現 checkAchievements 方法檢查解鎖條件
    - 實現 unlockAchievement 方法
    - 實現 getAllAchievements、getProgress 方法
    - 實現成就持久化
    - _需求：14.1, 14.2, 14.3, 14.4, 14.5_

  - [ ]* 8.2 為 AchievementSystem 編寫基於屬性的測試
    - **屬性 30: 成就里程碑追蹤**
    - **驗證需求：14.1**

  - [ ]* 8.3 為 AchievementSystem 編寫基於屬性的測試
    - **屬性 31: 成就解鎖條件**
    - **驗證需求：14.2**

  - [ ]* 8.4 為 AchievementSystem 編寫基於屬性的測試
    - **屬性 32: 成就持久化 Round-Trip**
    - **驗證需求：14.5**

  - [ ]* 8.5 編寫單元測試
    - 測試至少 10 個成就存在
    - 測試各種成就解鎖場景
    - _需求：14.4_

- [x] 9. 實現謎題庫和每日挑戰
  - [x] 9.1 創建謎題庫
    - 為每個難度等級創建至少 10 個謎題
    - 驗證所有謎題有唯一解
    - 實現謎題數據結構和存儲
    - _需求：12.1, 12.3_

  - [x] 9.2 實現 PuzzleGenerator 類
    - 實現從謎題庫隨機選擇謎題
    - 實現已完成謎題追蹤和去重邏輯
    - 實現謎題驗證方法
    - _需求：12.2, 12.4_

  - [x] 9.3 實現 DailyChallenge 類
    - 實現基於日期的確定性謎題生成
    - 實現 getTodayChallenge 方法
    - 實現 recordCompletion 方法
    - 實現 getHistory、isTodayCompleted 方法
    - _需求：13.1, 13.2, 13.3, 13.4, 13.5_

  - [ ]* 9.4 為謎題系統編寫基於屬性的測試
    - **屬性 25: 謎題選擇正確性**
    - **驗證需求：12.2**

  - [ ]* 9.5 為謎題系統編寫基於屬性的測試
    - **屬性 26: 謎題唯一解**
    - **驗證需求：12.3**

  - [ ]* 9.6 為謎題系統編寫基於屬性的測試
    - **屬性 27: 謎題去重**
    - **驗證需求：12.4**

  - [ ]* 9.7 為每日挑戰編寫基於屬性的測試
    - **屬性 28: 每日挑戰確定性**
    - **驗證需求：13.1, 13.4**

  - [ ]* 9.8 為每日挑戰編寫基於屬性的測試
    - **屬性 29: 每日挑戰記錄**
    - **驗證需求：13.3**

  - [ ]* 9.9 編寫單元測試
    - 測試每個難度至少 10 個謎題
    - _需求：12.1_

- [x] 10. 檢查點 - 功能模塊驗證
  - 確保統計、成就和謎題系統測試通過
  - 驗證數據持久化和業務邏輯正確
  - 如有問題請詢問用戶

- [x] 11. 實現主題管理
  - [x] 11.1 實現 ThemeManager 類
    - 定義亮色和暗色主題的 CSS 變量
    - 實現 setTheme 方法
    - 實現 applyTheme 方法更新 CSS 變量
    - 實現 getCurrentTheme 方法
    - 實現主題偏好持久化
    - _需求：8.1, 8.2, 8.3, 8.4, 8.5_

  - [ ]* 11.2 為 ThemeManager 編寫基於屬性的測試
    - **屬性 20: 主題應用和持久化**
    - **驗證需求：8.1, 8.2, 8.3**

  - [ ]* 11.3 編寫單元測試
    - 測試兩種主題都存在
    - 測試 CSS 變量正確設置
    - _需求：8.4_

- [x] 12. 實現計時器
  - [x] 12.1 實現 Timer 類
    - 實現 start、pause、resume、stop 方法
    - 實現 getElapsedTime 方法
    - 實現計時器狀態管理
    - _需求：6.4, 7.1_

  - [ ]* 12.2 編寫單元測試
    - 測試計時器基本功能
    - 測試暫停和恢復
    - _需求：6.4_

- [x]* 13. 實現音效系統（可選）
  - [x]* 13.1 實現 SoundManager 類
    - 使用 Web Audio API 生成或加載音效
    - 實現不同事件的音效（輸入、錯誤、完成）
    - 實現音效開關控制
    - 實現音效偏好持久化
    - _需求：18.1, 18.2, 18.3, 18.4, 18.5, 18.6_

  - [ ]* 13.2 為 SoundManager 編寫基於屬性的測試
    - **屬性 39: 音效事件觸發**
    - **驗證需求：18.1, 18.2, 18.3**

  - [ ]* 13.3 為 SoundManager 編寫基於屬性的測試
    - **屬性 40: 音效偏好持久化**
    - **驗證需求：18.5**

  - [ ]* 13.4 編寫單元測試
    - 測試音效開關選項
    - _需求：18.4_

- [x] 14. 實現遊戲控制器
  - [x] 14.1 實現 GameController 類
    - 實現遊戲狀態管理（GameState）
    - 實現用戶操作處理（選擇格子、輸入數字、切換筆記模式）
    - 實現自動檢查模式邏輯
    - 實現高亮相同數字邏輯
    - 實現遊戲完成檢測和處理
    - 協調所有核心模塊（Grid、History、Hint、Timer、Statistics、Achievement）
    - 實現自動保存邏輯（使用防抖）
    - _需求：3.1, 3.2, 4.1, 4.2, 4.3, 4.4, 5.1, 6.1, 11.2, 11.3, 19.4_

  - [ ]* 14.2 為 GameController 編寫基於屬性的測試
    - **屬性 7: 筆記模式允許多個數字**
    - **驗證需求：3.1**

  - [ ]* 14.3 為 GameController 編寫基於屬性的測試
    - **屬性 8: 筆記切換的冪等性**
    - **驗證需求：3.2**

  - [ ]* 14.4 為 GameController 編寫基於屬性的測試
    - **屬性 13: 高亮相同數字**
    - **驗證需求：5.1**

  - [ ]* 14.5 為 GameController 編寫基於屬性的測試
    - **屬性 23: 勝利數據正確傳遞**
    - **驗證需求：11.2**

  - [ ]* 14.6 為 GameController 編寫基於屬性的測試
    - **屬性 24: 新記錄檢測**
    - **驗證需求：11.3**

  - [ ]* 14.7 為 GameController 編寫基於屬性的測試
    - **屬性 41: 防抖節流行為**
    - **驗證需求：19.4**

  - [ ]* 14.8 編寫單元測試
    - 測試自動檢查模式禁用
    - 測試選中空白格子不高亮
    - 測試取消選擇移除高亮
    - _需求：4.4, 5.2, 5.3_

- [x] 15. 檢查點 - 核心邏輯集成驗證
  - 確保 GameController 正確協調所有模塊
  - 驗證遊戲流程完整性
  - 如有問題請詢問用戶


- [x] 16. 實現網格視圖 UI
  - [x] 16.1 實現 GridView 類
    - 渲染 9x9 網格 HTML 結構
    - 實現格子選擇和高亮顯示
    - 實現數字顯示（固定數字、用戶輸入、提示）
    - 實現筆記顯示（小數字）
    - 實現衝突高亮（紅色）
    - 實現相同數字高亮
    - 實現觸控和鍵盤事件處理
    - 實現響應式佈局（移動端優化）
    - _需求：3.5, 4.2, 4.3, 5.1, 5.4, 10.1, 10.2, 10.3, 10.4, 10.5_

  - [ ]* 16.2 編寫單元測試
    - 測試網格渲染
    - 測試事件處理
    - _需求：10.1, 10.2_

- [x] 17. 實現鍵盤視圖 UI
  - [x] 17.1 實現 KeypadView 類
    - 渲染數字鍵盤（1-9）
    - 渲染控制按鈕（撤銷、重做、提示、筆記模式、清除）
    - 實現按鈕點擊事件處理
    - 實現按鈕狀態更新（啟用/禁用）
    - 實現觸控優化（最小 44x44 像素）
    - _需求：2.3, 2.4, 10.1_

  - [ ]* 17.2 編寫單元測試
    - 測試按鈕渲染和事件
    - _需求：2.3, 2.4_

- [x] 18. 實現設置面板 UI
  - [x] 18.1 實現 SettingsPanel 類
    - 渲染設置面板 HTML 結構
    - 實現主題切換控件
    - 實現自動檢查開關
    - 實現音效開關
    - 實現其他設置選項（高亮相同數字、顯示計時器等）
    - 實現重置統計按鈕
    - 實現設置變更事件處理
    - 實現設置立即生效
    - _需求：9.1, 9.2, 9.3, 9.4, 9.5_

  - [ ]* 18.2 為設置面板編寫基於屬性的測試
    - **屬性 21: 設置立即生效**
    - **驗證需求：9.3**

  - [ ]* 18.3 為設置面板編寫基於屬性的測試
    - **屬性 22: 設置持久化 Round-Trip**
    - **驗證需求：9.4**

  - [ ]* 18.4 編寫單元測試
    - 測試所有設置選項存在
    - 測試重置統計功能
    - _需求：9.2, 9.5_

- [x] 19. 實現勝利動畫 UI
  - [x] 19.1 實現 VictoryAnimation 類
    - 實現勝利動畫效果（CSS 動畫或 JavaScript 動畫）
    - 顯示完成時間、錯誤數、提示使用數
    - 顯示新記錄標註（如果適用）
    - 實現開始新遊戲按鈕
    - 實現查看統計按鈕
    - 實現關閉/跳過動畫功能
    - _需求：11.1, 11.2, 11.3, 11.4, 11.5_

  - [ ]* 19.2 編寫單元測試
    - 測試勝利動畫觸發
    - 測試數據顯示
    - _需求：11.1, 11.4, 11.5_

- [x] 20. 實現統計和成就 UI
  - [x] 20.1 實現統計顯示界面
    - 顯示總遊戲數、平均時間、最佳時間、勝率
    - 按難度分類顯示統計
    - 實現統計數據更新
    - _需求：7.3_

  - [x] 20.2 實現成就列表界面
    - 顯示所有成就（已解鎖和未解鎖）
    - 顯示成就進度
    - 實現成就解鎖通知
    - _需求：14.2, 14.3_

  - [ ]* 20.3 編寫單元測試
    - 測試統計和成就 UI 渲染
    - _需求：7.3, 14.3_

- [x] 21. 實現每日挑戰 UI
  - [x] 21.1 實現每日挑戰界面
    - 顯示當天的挑戰謎題
    - 顯示每日挑戰歷史記錄
    - 實現挑戰完成標記
    - _需求：13.2, 13.5_

  - [ ]* 21.2 編寫單元測試
    - 測試每日挑戰 UI 渲染
    - _需求：13.2, 13.5_

- [x] 22. 實現可訪問性支持
  - [x] 22.1 添加 ARIA 標籤和角色
    - 為所有互動元素添加適當的 ARIA 標籤
    - 為網格格子添加 role、aria-label、aria-selected
    - 為按鈕添加 aria-label、aria-pressed
    - 為動態內容添加 aria-live regions
    - _需求：17.1, 17.6_

  - [x] 22.2 實現鍵盤導航
    - 實現 Tab 鍵導航
    - 實現方向鍵在網格中移動
    - 實現 Enter/Space 鍵選擇和確認
    - 實現數字鍵快捷輸入
    - 實現焦點管理和焦點指示器
    - _需求：17.2, 17.5_

  - [x] 22.3 實現屏幕閱讀器支持
    - 為元素提供有意義的描述
    - 為狀態變化提供通知
    - 確保所有信息通過多種方式傳達（不僅依賴顏色）
    - _需求：17.3, 17.4_

  - [ ]* 22.4 為可訪問性編寫基於屬性的測試
    - **屬性 35: ARIA 標籤完整性**
    - **驗證需求：17.1**

  - [ ]* 22.5 為可訪問性編寫基於屬性的測試
    - **屬性 36: 鍵盤導航支持**
    - **驗證需求：17.2**

  - [ ]* 22.6 為可訪問性編寫基於屬性的測試
    - **屬性 37: 屏幕閱讀器描述**
    - **驗證需求：17.3, 17.6**

  - [ ]* 22.7 為可訪問性編寫基於屬性的測試
    - **屬性 38: 焦點管理**
    - **驗證需求：17.5**

- [x] 23. 檢查點 - UI 集成驗證
  - 確保所有 UI 組件正確渲染和交互
  - 驗證可訪問性功能
  - 測試移動端體驗
  - 如有問題請詢問用戶

- [x] 24. 實現樣式和主題
  - [x] 24.1 創建 CSS 樣式
    - 定義 CSS 變量用於主題
    - 實現網格樣式（邊框、間距、顏色）
    - 實現格子狀態樣式（選中、高亮、錯誤、提示）
    - 實現按鈕和控件樣式
    - 實現響應式佈局（媒體查詢）
    - 實現動畫效果（過渡、勝利動畫）
    - _需求：8.4, 8.5, 10.1, 10.2, 10.5, 11.1_

  - [ ]* 24.2 編寫單元測試
    - 測試主題 CSS 變量
    - 測試響應式斷點
    - _需求：8.4, 10.2_

- [ ]* 25. 實現代碼文檔
  - [x]* 25.1 添加 JSDoc 註釋
    - 為所有公共函數和方法添加 JSDoc
    - 為複雜算法添加內聯註釋
    - 為每個模塊添加文件頂部文檔
    - 記錄所有數據結構和接口
    - 為關鍵設計決策添加解釋性註釋
    - _需求：20.1, 20.2, 20.3, 20.4, 20.5_

  - [ ]* 25.2 為文檔編寫基於屬性的測試
    - **屬性 42: JSDoc 註釋存在**
    - **驗證需求：20.1**

  - [ ]* 25.3 為文檔編寫基於屬性的測試
    - **屬性 43: 模塊文檔存在**
    - **驗證需求：20.3**

  - [ ]* 25.4 為文檔編寫基於屬性的測試
    - **屬性 44: 數據結構文檔**
    - **驗證需求：20.4**

- [x] 26. 性能優化
  - [x] 26.1 實現性能優化
    - 使用事件委託減少事件監聽器
    - 實現防抖/節流（自動保存、輸入驗證）
    - 優化 DOM 操作（批量更新、DocumentFragment）
    - 優化渲染性能（requestAnimationFrame）
    - 實現懶加載（音效、動畫資源）
    - _需求：19.1, 19.2, 19.3, 19.4, 19.5_

  - [ ]* 26.2 編寫性能測試
    - 測試防抖/節流功能
    - _需求：19.4_

- [x] 27. 集成測試
  - [x] 27.1 編寫端到端集成測試
    - 測試完整遊戲流程（開始 → 輸入 → 完成）
    - 測試持久化流程（保存 → 刷新 → 恢復）
    - 測試成就解鎖流程
    - 測試每日挑戰流程
    - _需求：所有需求_

- [x] 28. 最終檢查點和優化
  - 運行所有測試確保通過
  - 手動測試所有功能
  - 測試不同瀏覽器和設備
  - 使用 axe-core 進行可訪問性測試
  - 優化性能和用戶體驗
  - 修復發現的任何問題
  - 如有問題請詢問用戶

## 注意事項

- 每個任務都引用了相關的需求編號以便追溯
- 檢查點任務確保增量驗證
- 基於屬性的測試驗證通用正確性屬性
- 單元測試驗證特定示例和邊緣情況
- 所有測試應使用 fast-check 進行基於屬性的測試，每個測試最少 100 次迭代
- 所有任務都是必需的，以確保從一開始就實現全面的功能和測試覆蓋
